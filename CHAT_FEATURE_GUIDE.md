# 对话功能使用指南

## 功能概述

本项目已成功集成 **LangChain** 框架,实现了基于音频转录内容的智能对话功能。用户可以上传音频文件,系统会自动转录并建立向量索引,之后用户可以对转录内容进行提问,模型会基于转录文本进行准确回答。

## 技术实现

### 后端实现 (app.py)

1. **依赖集成**
   - LangChain: 构建LLM应用的框架
   - LangChain-OpenAI: OpenAI模型集成
   - FAISS: 向量数据库,用于高效检索
   - OpenAI Embeddings: 文本向量化

2. **核心功能**
   - **会话管理**: 每个音频转录后创建唯一会话ID
   - **向量存储**: 转录文本分块并存储到FAISS向量数据库
   - **RAG检索**: 对话时检索相关文本片段
   - **对话记忆**: 保持对话上下文,支持多轮对话
   - **流式输出**: 实时显示AI回答

3. **API接口**

#### POST /process-with-summary
处理音频文件,返回转录、总结和会话ID
```
响应事件类型:
- status: 处理状态更新
- transcription: 转录结果
- summary_chunk: 总结片段(流式)
- session_created: 会话创建(包含session_id)
- complete: 处理完成
```

#### POST /chat
基于转录文本的对话接口
```json
请求:
{
  "session_id": "uuid-string",
  "message": "用户的问题"
}

响应事件类型:
- status: 思考状态
- chat_chunk: 回答片段(流式)
- complete: 回答完成
- error: 错误信息
```

#### GET /session/{session_id}
获取会话信息
```json
响应:
{
  "session_id": "uuid-string",
  "transcription": "转录文本内容",
  "chat_history_count": 2
}
```

### 前端实现 (index.html)

1. **对话界面**
   - 聊天消息区域(支持滚动)
   - 用户消息和AI回答的区分显示
   - 输入框和发送按钮
   - 流式显示AI回答

2. **交互流程**
   - 音频上传并处理完成后,自动启用对话功能
   - 接收到session_id后激活对话界面
   - 用户输入问题并发送
   - 实时显示AI回答(流式)
   - 支持Enter键快捷发送

3. **UI特性**
   - 现代化聊天界面设计
   - 用户消息右对齐,蓝紫渐变背景
   - AI消息左对齐,白色背景
   - 平滑的动画效果
   - 自动滚动到最新消息

## 使用流程

### 1. 环境配置

创建 `.env` 文件:
```bash
OPENAI_API_KEY=your_openai_api_key_here
```

安装依赖:
```bash
pip install -r requirements.txt
```

### 2. 启动服务

```bash
# 启动后端
python app.py

# 启动前端(新终端)
python -m http.server 8080
```

### 3. 使用应用

1. 打开浏览器访问 `http://localhost:8080`
2. 上传音频文件
3. 等待转录和总结完成
4. 对话功能自动启用
5. 在对话框中输入问题
6. 查看AI基于转录内容的回答

## 功能特性

### RAG (检索增强生成)

系统使用RAG技术确保AI回答的准确性:

1. **文本分块**: 转录文本分成500字符的片段,重叠50字符
2. **向量化**: 使用OpenAI Embeddings将文本转为向量
3. **相似度检索**: 根据问题检索最相关的3个文本片段
4. **上下文回答**: AI基于检索到的片段进行回答

### 对话记忆

系统保持对话历史,支持:
- 多轮对话
- 上下文理解
- 追问和澄清

### 会话管理

- 每个转录创建独立会话
- 会话自动过期(1小时未使用)
- 支持多个并发会话

## 示例对话

**用户**: 这段音频的主要内容是什么?

**AI**: 根据转录内容,这段音频主要讨论了...

**用户**: 提到了哪些具体的数据?

**AI**: 在转录文本中提到的具体数据包括...

## 技术亮点

1. **完全流式体验**: 从转录到总结到对话,全程流式输出
2. **准确性保证**: RAG技术确保回答基于实际转录内容
3. **用户体验**: 现代化UI,实时反馈,流畅交互
4. **可扩展性**: 模块化设计,易于扩展新功能
5. **性能优化**: FAISS向量检索,高效快速

## 注意事项

1. **API费用**: 使用OpenAI API会产生费用,包括:
   - Whisper转录费用
   - Embeddings向量化费用
   - GPT-4o-mini对话费用

2. **会话过期**: 会话1小时未使用会自动清理

3. **文件大小**: 音频文件限制25MB

4. **网络要求**: 需要稳定的网络连接

## 故障排除

### 对话功能未启用

- 检查转录是否完成
- 查看浏览器控制台是否有错误
- 确认收到了session_id

### 回答不准确

- 检查转录质量
- 音频内容是否清晰
- 尝试更具体的问题

### 服务器错误

- 检查OPENAI_API_KEY是否配置
- 查看后端日志
- 确认API余额充足

## 未来改进方向

1. 支持多语言对话
2. 导出对话记录
3. 自定义提示词
4. 语音问答(语音输入+语音输出)
5. 对话历史可视化

