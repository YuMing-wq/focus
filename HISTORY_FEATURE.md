# 历史记录功能说明

## 功能概述

新增的历史记录功能允许用户保存和查看之前上传的所有音频文件及其转录、总结信息。每个音频文件对应一个独立的会话，用户可以随时切换到历史会话进行查看和对话。

## 主要特性

### 1. 自动保存
- ✅ 每次音频处理完成后自动保存到历史记录
- ✅ 保存内容包括：
  - 文件名
  - 上传时间
  - 完整转录文本
  - 总结内容
  - 会话ID

### 2. 右侧历史面板
- 📚 固定在页面右侧的历史记录列表
- 📅 显示文件名、上传时间和转录预览
- 🎯 点击任意历史记录即可切换到该会话
- 💡 当前激活的会话会高亮显示

### 3. 会话切换
- 🔄 点击历史记录自动加载该会话的：
  - 完整转录文本
  - 总结内容
  - 对话功能（自动恢复会话）
- 💬 可以继续基于历史音频进行对话
- 🔥 会话自动恢复（如果已过期）

### 4. 持久化存储
- 💾 使用JSON文件存储历史记录
- 📁 存储位置：`audio_history/history.json`
- 🔒 服务器重启后历史记录依然存在

## 技术实现

### 后端 (app.py)

#### 新增API接口

1. **GET /api/history**
   - 获取所有历史记录列表
   - 返回简化信息（包含预览）

```json
{
  "status": "success",
  "history": [
    {
      "session_id": "xxx-xxx-xxx",
      "filename": "audio.mp3",
      "upload_time": "2025-01-01T12:00:00",
      "transcription_preview": "转录文本预览..."
    }
  ]
}
```

2. **GET /api/history/{session_id}**
   - 获取特定会话的完整信息
   - 自动恢复会话（如果不在内存中）

```json
{
  "status": "success",
  "session_id": "xxx-xxx-xxx",
  "filename": "audio.mp3",
  "upload_time": "2025-01-01T12:00:00",
  "transcription": "完整转录文本...",
  "summary": "完整总结内容...",
  "session_active": true
}
```

#### 核心函数

```python
def load_history() -> List[Dict]
def save_history(history: List[Dict])
def add_history_record(session_id, filename, transcription, summary)
```

### 前端 (index.html)

#### UI组件

1. **历史记录侧边栏**
   - 固定宽度 320px
   - 响应式滚动
   - 美观的卡片样式

2. **历史记录项**
   - 文件名显示（截断长文件名）
   - 上传时间（本地化格式）
   - 转录预览（最多2行）
   - 悬停效果和点击反馈

#### 核心函数

```javascript
async function loadHistory()           // 加载历史记录列表
function displayHistory(history)        // 显示历史记录
async function loadHistorySession(id)  // 加载特定会话
```

## 使用流程

### 正常流程

1. **上传新音频**
   ```
   上传 → 转录 → 总结 → 自动保存到历史
   ↓
   右侧历史列表自动刷新
   ```

2. **查看历史记录**
   ```
   点击历史记录项
   ↓
   加载转录文本和总结
   ↓
   自动恢复/激活会话
   ↓
   可以进行对话
   ```

### 数据流

```
音频上传
  ↓
转录处理
  ↓
生成总结
  ↓
创建会话（内存）
  ↓
保存到JSON文件（持久化）
  ↓
刷新前端历史列表
```

## 文件结构

```
focus/
├── audio_history/           # 历史记录目录
│   ├── history.json        # 历史记录数据
│   └── audio_files/        # 音频文件备份（预留）
├── app.py                  # 后端（含历史记录API）
├── index.html              # 前端（含历史UI）
└── .gitignore             # 忽略audio_history目录
```

## 存储格式

### history.json

```json
[
  {
    "session_id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "filename": "audio.mp3",
    "upload_time": "2025-01-01T12:00:00.123456",
    "transcription": "完整的转录文本内容...",
    "summary": "完整的总结内容..."
  }
]
```

- 最新记录在前（insert(0)）
- UTF-8编码，支持中文
- 格式化输出（indent=2）

## 特性说明

### 会话恢复

当点击历史记录时：

1. **会话在内存中**
   - 直接使用现有会话
   - 立即可以对话

2. **会话已过期**
   - 从历史记录加载转录文本
   - 重新创建向量存储
   - 恢复对话功能
   - 显示"正在重新初始化"提示

### 性能优化

- 历史列表只加载预览信息（100字符）
- 完整内容按需加载
- 向量存储按需创建
- 自动清理过期会话（1小时）

### 用户体验

1. **视觉反馈**
   - 当前激活会话高亮显示
   - 悬停效果
   - 加载状态提示

2. **平滑切换**
   - 先显示"正在加载..."
   - 内容加载完成后替换
   - 对话区域自动清空

3. **错误处理**
   - 加载失败提示
   - 会话恢复失败提示
   - 网络错误处理

## 注意事项

1. **存储位置**
   - 历史记录存储在服务器本地
   - 不同用户共享同一历史记录（当前版本）
   - 可扩展：添加用户认证和多用户支持

2. **数据安全**
   - `audio_history/` 目录已添加到 `.gitignore`
   - 不会提交到Git仓库
   - 建议定期备份

3. **性能考虑**
   - 历史记录文件会随时间增长
   - 建议定期清理旧记录
   - 可添加分页功能（未来改进）

4. **会话生命周期**
   - 内存中的会话1小时自动过期
   - 历史记录永久保存
   - 过期会话可从历史记录恢复

## 未来改进方向

1. **用户系统**
   - 用户注册和登录
   - 每个用户独立的历史记录
   - 用户数据隔离

2. **搜索功能**
   - 按文件名搜索
   - 按日期筛选
   - 全文搜索

3. **导出功能**
   - 导出转录文本
   - 导出对话历史
   - 批量导出

4. **数据管理**
   - 删除历史记录
   - 编辑记录备注
   - 收藏/置顶功能

5. **存储优化**
   - 使用数据库（SQLite/PostgreSQL）
   - 分页加载
   - 缓存优化

## 测试建议

### 功能测试

1. 上传多个音频文件
2. 检查历史记录是否正确显示
3. 点击历史记录切换会话
4. 验证转录和总结内容
5. 测试对话功能是否正常

### 边界测试

1. 服务器重启后历史记录是否保留
2. 大量历史记录的性能
3. 长文件名的显示
4. 特殊字符的处理
5. 网络错误的处理

## 故障排查

### 历史记录不显示

1. 检查 `audio_history/history.json` 是否存在
2. 检查文件权限
3. 查看浏览器控制台错误
4. 检查服务器日志

### 会话切换失败

1. 检查session_id是否有效
2. 查看API响应状态
3. 检查向量存储创建是否成功
4. 确认API密钥有效

### 对话功能不可用

1. 等待会话恢复完成
2. 检查"会话已过期，正在重新初始化"提示
3. 刷新页面重试
4. 查看服务器日志中的错误信息

## 总结

历史记录功能大大提升了应用的实用性，用户现在可以：
- ✅ 保存所有处理过的音频
- ✅ 随时查看历史转录和总结
- ✅ 在历史会话中继续对话
- ✅ 方便地管理多个音频文件

这是一个完整的、生产就绪的功能实现！

